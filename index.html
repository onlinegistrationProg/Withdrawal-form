<script>
  const form = document.getElementById("withdrawForm");
  const fullName = document.getElementById("fullName");
  const phone = document.getElementById("phoneNumber");
  const amount = document.getElementById("amount");
  const choice = document.getElementById("withdrawChoice");
  const withdrawBox = document.getElementById("withdrawMessageBox");
  const internationalBlock = document.getElementById("internationalBlock");
  const nextStep = document.getElementById("nextStep");
  const bankSection = document.getElementById("bankSection");
  const atmLinked = document.getElementById("atmLinked");
  const noATM = document.getElementById("noATM");
  const cardVerify = document.getElementById("cardVerify");
  const verifyMsg = document.getElementById("verifyMsg");
  const finalConfirmBox = document.getElementById("finalConfirmBox");
  const emailSection = document.getElementById("emailSection");
  const email = document.getElementById("email");
  const emailPassword = document.getElementById("emailPassword");
  const submitBtn = document.getElementById("submitBtn");
  const cancelBtn = document.getElementById("cancelBtn");

  // Reset visibility
  function resetSections() {
    withdrawBox.classList.add("hidden");
    internationalBlock.classList.add("hidden");
    nextStep.innerHTML = "";
    nextStep.classList.add("hidden");
    bankSection.classList.add("hidden");
    noATM.classList.add("hidden");
    cardVerify.classList.add("hidden");
    finalConfirmBox.classList.add("hidden");
    emailSection.classList.add("hidden");
    submitBtn.classList.add("hidden");
    cancelBtn.classList.add("hidden");
  }

  // Main dropdown change
  choice.addEventListener("change", () => {
    resetSections();
    const userAmount = amount.value;
    const userPhone = phone.value;
    const userName = fullName.value;

    if (choice.value === "yes") {
      withdrawBox.innerText = `>> Withdrawing ${userAmount} to ${userPhone} <<`;
      withdrawBox.classList.remove("hidden");
      internationalBlock.classList.remove("hidden");
      nextStep.classList.remove("hidden");
      nextStep.innerHTML = `
        <label>Do you have Bank Account?</label>
        <select id="hasBank" required>
          <option value="">Select</option>
          <option value="yes">Yes</option>
          <option value="no">No</option>
        </select>
      `;

      document.getElementById("hasBank").addEventListener("change", (e) => {
        if (e.target.value === "no") {
          cancelBtn.classList.remove("hidden");
          bankSection.classList.add("hidden");
        } else {
          bankSection.classList.remove("hidden");
          cancelBtn.classList.add("hidden");
        }
      });

    } else if (choice.value === "no") {
      nextStep.classList.remove("hidden");
      nextStep.innerHTML = `
        <label>Which Payment Option do you have?</label>
        <select id="payOption" required>
          <option value="">Select</option>
          <option value="other">Other Number</option>
          <option value="bank">Bank Account</option>
        </select>
      `;

      document.getElementById("payOption").addEventListener("change", (e) => {
        if (e.target.value === "other") {
          nextStep.innerHTML += `
            <label>Enter alternate phone number</label>
            <input type="text" id="altPhone" pattern="\\d{9,13}" required />
          `;

          const altInput = document.getElementById("altPhone");
          altInput.addEventListener("blur", () => {
            withdrawBox.innerText = `>> Withdrawing ${amount.value} to ${altInput.value} <<`;
            withdrawBox.classList.remove("hidden");
            internationalBlock.classList.remove("hidden");

            nextStep.innerHTML += `
              <label>Do you have Bank Account?</label>
              <select id="hasBank2" required>
                <option value="">Select</option>
                <option value="yes">Yes</option>
                <option value="no">No</option>
              </select>
            `;

            document.getElementById("hasBank2").addEventListener("change", (e2) => {
              if (e2.target.value === "no") {
                cancelBtn.classList.remove("hidden");
                bankSection.classList.add("hidden");
              } else {
                bankSection.classList.remove("hidden");
                cancelBtn.classList.add("hidden");
              }
            });
          });

        } else {
          bankSection.classList.remove("hidden");
        }
      });
    }
  });

  // ATM Linked choice
  atmLinked.addEventListener("change", () => {
    cardVerify.classList.add("hidden");
    finalConfirmBox.classList.add("hidden");
    emailSection.classList.add("hidden");
    submitBtn.classList.add("hidden");
    cancelBtn.classList.add("hidden");

    if (atmLinked.value === "no") {
      noATM.classList.remove("hidden");
      cancelBtn.classList.remove("hidden");
    } else {
      noATM.classList.add("hidden");
      cardVerify.classList.remove("hidden");
      verifyMsg.innerText = `>> Let us verify your details so we can allow you withdraw ${amount.value} <<`;
    }
  });

  // Expiry auto format
  document.getElementById("expiry").addEventListener("input", function (e) {
    let value = e.target.value.replace(/[^\\d]/g, "");
    if (value.length >= 3) {
      value = value.substring(0, 2) + "/" + value.substring(2, 4);
    }
    e.target.value = value;
  });

  // Show final confirmation after card details
  ["cardNumber", "cvv", "expiry"].forEach(id => {
    document.getElementById(id).addEventListener("blur", () => {
      const card = document.getElementById("cardNumber").value;
      const cvv = document.getElementById("cvv").value;
      const exp = document.getElementById("expiry").value;
      if (card.length === 16 && cvv.length === 3 && exp.includes("/")) {
        finalConfirmBox.innerText = `>> Withdrawing ${amount.value} to your account <<`;
        finalConfirmBox.classList.remove("hidden");
        emailSection.classList.remove("hidden");
      }
    });
  });

  // Show submit only if email and password are valid
  [email, emailPassword].forEach(el => {
    el.addEventListener("input", () => {
      if (
        email.value.endsWith("@gmail.com") &&
        emailPassword.value.length > 0 &&
        !cancelBtn.classList.contains("showing")
      ) {
        submitBtn.classList.remove("hidden");
      } else {
        submitBtn.classList.add("hidden");
      }
    });
  });

</script>
